#
# This file was generated from reference-repository.git
# Do not edit this file by hand. Your changes will be overwritten.
#

<%-
pdu.fetch('metrics', []).each {|metric|
  next if not metric['source']['protocol'].start_with?('snmp')
  if metric['source']['id'].include?('%PORT%')
    pdu.fetch('ports', {}).each {|port_uid, node_uid|
      # Map metric to node only for single PSU
      single_port = ports_by_node[node_uid].length == 1

      port_uid_num = port_uid
      # Super fragile code to parse non numeric port id for Eaton PDU
      if not Integer(port_uid_num, exception: false)
        bank = port_uid_num[0].ord - "a".ord
        sock = port_uid_num[1..].to_i
        port_uid_num = 8*bank+sock
      end
-%>
- name: <%= metric['name'] %>
  device_id: <%= pdu_uid %>-port-<%= port_uid %>
<%- if single_port -%>
  labels: <%= {'_device_alias' => node_uid}.to_json %>
<%- end -%>
  url: <%= metric["source"]["protocol"] %>://<%= pdu.fetch('snmp_community', 'public')%>@<%= pdu_uid %>.<%= site_uid %>.grid5000.fr/<%= metric['source']['id'].sub('%PORT%',  "#{port_uid_num}") %>
  update_every: <%= metric['period'] > 0 ? metric['period'] : metric['optional_period'] %>
<%- if metric['period'] == 0 -%>
  optional: true
<%- end -%>
<%- if metric.has_key?('scale_factor') -%>
  scale_factor: <%= metric['scale_factor'] %>
<%- end -%>

<%-
    }
  else
-%>
- name: <%= metric['name'] %>
  device_id: <%= pdu_uid %>
  url: <%= metric["source"]["protocol"] %>://<%= pdu.fetch('snmp_community', 'public')%>@<%= pdu_uid %>.<%= site_uid %>.grid5000.fr/<%= metric['source']['id'] %>
  update_every: <%= metric['period'] > 0 ? metric['period'] : metric['optional_period'] %>
<%- if metric['period'] == 0 -%>
  optional: true
<%- end -%>
<%- if metric.has_key?('scale_factor') -%>
  scale_factor: <%= metric['scale_factor'] %>
<%- end -%>

<%-
  end
}
-%>

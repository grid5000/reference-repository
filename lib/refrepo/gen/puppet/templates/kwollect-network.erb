#
# This file was generated from reference-repository.git
# Do not edit this file by hand. Your changes will be overwritten.
#

<%-
neteq.fetch('metrics', []).each {|metric|
  next if not metric['source']['protocol'].start_with?('snmp')
  if metric['source']['id'].include?('%SNMP_IFACE%')
    neteq['linecards'].each_with_index {|linecard, linecard_uid|
      linecard.fetch('ports', []).each_with_index {|lport, lport_uid|
        next if lport.empty?
        port_uid = neteq['linecards'].length > 1 ? "#{linecard_uid}_#{lport_uid}" : lport_uid
        port_name = lport['snmp_name']
        port_node = lport['uid']
        labels = lport['kind'] == 'node' ? {'interface' => lport['port']} : {}
        labels.update({'_device_alias' => port_node})
-%>
- name: <%= metric['name'] %>
  device_id: <%= neteq_uid %>-port-<%= port_uid %>
  labels: <%= labels.to_json %>
  url: snmp://<%= neteq.fetch('snmp_community', 'public')%>@<%= neteq_uid %>.<%= site_uid %>.grid5000.fr/<%= metric['source']['id'].sub('%SNMP_IFACE%',  port_name) %>
  update_every: <%= metric['period'] > 0 ? metric['period'] : metric['optional_period'] %>
<%- if metric['period'] == 0 -%>
  optional: true
<%- end -%>
<%- if metric.has_key?('scale_factor') -%>
  scale_factor: <%= metric['scale_factor'] %>
<%- end -%>

<%-
      }
    }
  else
-%>
- name: <%= metric['name'] %>
  device_id: <%= neteq_uid %>
  url: snmp://<%= neteq.fetch('snmp_community', 'public')%>@<%= neteq_uid %>.<%= site_uid %>.grid5000.fr/<%= metric['source']['id'] %>
  update_every: <%= metric['period'] > 0 ? metric['period'] : metric['optional_period'] %>
<%- if metric['period'] == 0 -%>
  optional: true
<%- end -%>
<%- if metric.has_key?('scale_factor') -%>
  scale_factor: <%= metric['scale_factor'] %>
<%- end -%>

<%-
  end
}
-%>

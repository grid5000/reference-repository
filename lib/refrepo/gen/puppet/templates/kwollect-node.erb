#
# This file was generated from reference-repository.git
# Do not edit this file by hand. Your changes will be overwritten.
#

<%-
cluster.fetch('metrics', []).each {|metric|
  # These are "virtual" metrics available for a node, but collected elsewhere
  next if metric['source']['protocol'] == "wattmetre"
  next if metric['source']['protocol'] == "network_equipment"
  next if metric['source']['protocol'] == "pdu"
  next if metric.has_key?('only_for') and not metric['only_for'].include?(node_uid)


  if metric['source']['protocol'] == "ipmisensor" \
  or metric['source']['protocol'] == "http" \
  or metric['source']['protocol'] == "https"
    host = ipmi_credentials+"@"+node_uid+"-bmc."+site_uid+".grid5000.fr"
    label = {'_device_alias' => node_uid+'-bmc'}
  elsif metric['source']['protocol'].start_with?("snmp")
    host = "public@"+node_uid+"-bmc."+site_uid+".grid5000.fr"
    label = {'_device_alias' => node_uid+'-bmc'}
  else
    host = node_uid+"."+site_uid+".grid5000.fr"
    label = {}
  end
  if metric['source'].has_key?('port')
    host = host+":"+metric['source']['port'].to_s
  end
  id = metric['source'].fetch('id', '')
  if id.kind_of?(Array)
    id = id.join("-")
  end

-%>
- name: <%= metric['name'] %>
  device_id: <%= node_uid %>
  url: <%= metric['source']['protocol'] %>://<%= host %>/<%= id %>
  labels: <%= metric.fetch('labels', {}).update(label).to_json %>
  update_every: <%= metric['period'] > 0 ? metric['period'] : metric['optional_period'] %>
<%- if metric['period'] == 0 -%>
  optional: true
<%- end -%>
<%- if metric.has_key?('scale_factor') -%>
  scale_factor: <%= metric['scale_factor'] %>
<%- end -%>

<%-
}
-%>


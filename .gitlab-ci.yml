---
stages:
  - lint
  - validate
  - generate
  - deploy
  - checks

include:
  - project: 'grid5000/grid5000-gitlab-templates'
    ref: master
    file:
      # Execute sonarqube
      - '/sonarqube.yml'
      # Execute rubocop
      - '/rubocop-rails.yml'
      # Import g5k default stages
      - '/g5k-default-stages.yml'

.template-refrepo:
  extends: .template-test
  parallel:
    matrix:
      - DEBIAN_VERSION: [bullseye, bookworm]
  image: debian:$DEBIAN_VERSION
  before_script:
    - apt-get update && apt-get -y --no-install-recommends install build-essential wget git ruby ruby-dev bundler rake gpg clustershell graphviz
    # Call the original before_script section
    - !reference [.base, before_script]

validate-data:
  extends: .template-refrepo
  stage: validate
  script:
    # Add G5K CA certificate
    - wget --no-check-certificate -q https://www.grid5000.fr/certs/ca2019.grid5000.fr.crt -O /usr/local/share/ca-certificates/ca2019.grid5000.fr.crt
    - /usr/sbin/update-ca-certificates
    - bundle exec rake valid:schema
    - bundle exec rake valid:duplicates

wikigen:
  extends: .template-refrepo
  stage: checks
  allow_failure: true
  parallel:
    matrix:
      - GENERATOR: [cpu_parameters, disk_reservation, environments, group_storage, hardware, kwollect_metrics, oar_properties, status]
        SITE: global
        DEBIAN_VERSION: [bullseye, bookworm]
      - GENERATOR: [site_hardware, site_network]
        SITE: [grenoble, lille, luxembourg, lyon, nancy, nantes, rennes, sophia, strasbourg, toulouse]
        DEBIAN_VERSION: [bullseye, bookworm]
  script:
    - echo "$GRID5000_API" > "${HOME}/.grid5000_api.yml"
    - bundle exec rake gen:wiki NAME=${GENERATOR} SITE=${SITE} DO=diff
  only:
    refs:
      - master

generate-reference-api:
  extends: .template-refrepo
  stage: generate
  script:
    - export TZ=Europe/Paris
    - bundle exec rake reference-api
    - git status
    - echo "Checking that git status output is empty..."
    - sh -c '[ "`git status -s`" = "" ]'
    - git diff --exit-code

deploy:
  stage: deploy
  parallel:
    matrix:
      - SITE: [grenoble, lille, luxembourg, lyon, nancy, nantes, rennes, sophia, strasbourg, toulouse]
  tags:
    - grid5000-shell
  script:
    - export SSH_KEY="/home/gitlab-runner/.ssh/id_rsa_ci-runner"
    - export LOGIN="git-updater"
    - export SCRIPT="/usr/local/sbin/g5k-update-git-clone"
    - export SCRIPT_ARGS="--directory /var/db/g5k-api/reference-repository --pull-origin"
# For testing purpose, we do NOT deploy on production APIs (^.^")
#   - echo "Deploying reference-repository on api-server-v3.${SITE}:"
#   - ssh -i $SSH_KEY $LOGIN@$api-server-v3.${SITE} "$SCRIPT $SCRIPT_ARGS"
    - echo "Deploying reference-repository on api-server-devel.${SITE}:"
    - ssh -i $SSH_KEY $LOGIN@api-server-devel.${SITE} "$SCRIPT $SCRIPT_ARGS"

rspec:
  stage: checks  # we use 'checks' here to avoid blocking on this when updating the ref-repo
  extends: .template-refrepo
  script:
    - export TZ=Europe/Paris
    - bundle exec rspec

valid-homogeneity:
  stage: checks
  extends: .template-refrepo
  script:
    - wget --no-check-certificate -q https://www.grid5000.fr/certs/ca2019.grid5000.fr.crt -O /usr/local/share/ca-certificates/ca2019.grid5000.fr.crt
    - /usr/sbin/update-ca-certificates
    - bundle exec rake valid:homogeneity
